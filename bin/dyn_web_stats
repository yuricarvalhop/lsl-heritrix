#!/bin/env ruby

$LOAD_PATH << File.expand_path(File.join('..', 'lib'), File.dirname(__FILE__))

require 'cri'
require 'dyn_web_stats'

root_cmd = Cri::Command.define do
  name 'dyn_web_stats'
  summary 'Dynamic web statistics'

  run do |_, _, cmd|
    puts cmd.help
    exit -1
  end
end

crawl_cmd = Cri::Command.define do
  name 'crawl'
  summary 'Start next crawl'

  optional :m, :mongoid, 'mongoid config file', default: 'config/mongoid.yml'

  run do |opts, _|
    dws = DynWebStats.new(opts[:mongoid], config: nil)
    dws.run
  end
end

new_config_cmd = Cri::Command.define do
  name 'new_config'
  summary 'Create a new configuration'

  required :c, :capacity, 'maximum capacity'
  required :d, :description, 'config description'
  flag     :h, :help, 'show help'
  optional :m, :mongoid, 'mongoid config file', default: 'config/mongoid.yml'
  optional :s, :seeds, 'initial seeds (separated with comma)'

  run do |opts, _|
    capacity = opts[:capacity].to_i
    description = opts[:description]
    seeds = opts[:seeds].to_s.split(',')
    mongoid = opts[:mongoid]

    if !(capacity && description && seeds)
      print cmd.help
      exit -1
    end

    if capacity.zero?
      puts 'Capacity must be a positive number'
      exit -1
    end

    if description.nil?
      puts 'Description must be a valid word'
      exit -1
    end

    if seeds.empty?
      puts 'Seeds must be a valid list'
      exit -1
    end

    DynWebStats.new_config(mongoid, capacity, description, seeds)

    puts "Config created with no errors"
  end
end

root_cmd.add_command(crawl_cmd)
root_cmd.add_command(new_config_cmd)

root_cmd.run(ARGV)
